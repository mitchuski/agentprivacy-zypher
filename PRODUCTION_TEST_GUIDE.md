# Signal-to-Sanctuary Production Test Guide

**Complete guide for testing the donation flow with zebrad node**

Version 1.0 | December 2024

---

## üéØ Overview

This guide walks you through testing the complete Signal-to-Sanctuary donation flow with your running zebrad node. The flow implements the cryptographic separation of viewing keys (Oracle) and signing keys (Signer) with the golden ratio split (61.8% t-address / 38.2% z-address).

---

## ‚úÖ Prerequisites Checklist

Before starting, verify you have:

- [x] **Zebrad node running** and synced
- [ ] **RPC access** to zebrad (port 8232)
- [ ] **Environment variables** configured (`.env` file)
- [ ] **Keys generated** (viewing key + spending key)
- [ ] **IPFS spellbook** accessible (CID configured)
- [ ] **Oracle service** ready (or docker-compose)
- [ ] **Signer service** ready (or docker-compose)

---

## üîß Step 1: Setup Keys and Configuration

### 1.1 Generate Keys (if not done)

```bash
# Run the setup script
./setup-keys.sh
```

This will:
- Generate donation z-address
- Export viewing key (for Oracle)
- Export spending key (for Signer) ‚ö†Ô∏è **KEEP SECURE**
- Generate sanctuary t-address
- Generate protocol fee z-address
- Generate addresses for all 12 acts
- Upload spellbook to IPFS (if Pinata configured)

### 1.2 Configure Environment

Create `.env` file with:

```bash
# Zebra Node Configuration
ZEBRA_HOST=localhost
ZEBRA_PORT=8232
ZEBRA_USER=your_rpc_user
ZEBRA_PASS=your_rpc_pass

# Donation Address (generated by setup-keys.sh)
DONATION_Z_ADDRESS=zs1...
DONATION_VIEWING_KEY=zxviews1...
DONATION_SPENDING_KEY=zxsecrets1...  # ‚ö†Ô∏è SECURE THIS!

# Sanctuary & Fee Addresses
SANCTUARY_T_ADDRESS=t1...
PROTOCOL_FEE_Z_ADDRESS=zs1...

# NEAR Cloud AI - Oracle Swordsman (for verification)
NEAR_SWORDSMAN_API_KEY=sk-876c0f435b14449bac47f13583f5fd68
NEAR_API_URL=https://cloud-api.near.ai/v1
NEAR_MODEL=openai/gpt-oss-120b

# IPFS Configuration
IPFS_GATEWAY=https://red-acute-chinchilla-216.mypinata.cloud
SPELLBOOK_CID=bafkreiesrv2eolghj6mpbfpqwnff66fl5glevqmps3q6bzlhg5gtyf5jz4

# Service Ports
ORACLE_PORT=3000
SIGNER_PORT=3001

# Matching Threshold
MATCH_THRESHOLD=0.75  # Minimum semantic match score
```

---

## üß™ Step 2: Run Test Flow

### 2.1 Verify All Components

```bash
# Run comprehensive test
./test-flow.sh
```

This tests:
1. ‚úÖ Zebra node connection
2. ‚úÖ IPFS spellbook access
3. ‚úÖ Viewing key functionality
4. ‚úÖ Semantic matching
5. ‚úÖ Golden split calculation
6. ‚úÖ Inscription builder
7. ‚úÖ Oracle service health
8. ‚úÖ Signer service health

### 2.2 Expected Output

```
======================================
Signal-to-Sanctuary Test Flow
======================================

[1] Testing Zebra node connection
--------------------------------------
‚úì Connected to node at block 2500000

[2] Testing IPFS spellbook access
--------------------------------------
‚úì Spellbook accessible at https://...
‚úì Spellbook contains 12 acts

[3] Testing viewing key functionality
--------------------------------------
‚úì Viewing key functional

[4] Testing semantic proverb matching
--------------------------------------
‚úì Proverb match score: 0.8234 (above 0.75 threshold)

[5] Testing golden split calculation
--------------------------------------
‚úì Split calculated:
  Amount:    0.01 ZEC
  Sanctuary: 0.00618 ZEC (61.8%)
  Fee:       0.00382 ZEC (38.2%)

[6] Testing inscription builder
--------------------------------------
‚úì Inscription generated:
  STS|v01|ACT:5|H:a1b2c3d4...|A:61800000|T:1735000000
  Length: 65 bytes

[7] Testing Oracle service health
--------------------------------------
‚úì Oracle service healthy

[8] Testing Signer service health
--------------------------------------
‚úì Signer service healthy

[9] Simulating full donation flow (dry run)
--------------------------------------
Flow simulation:
1. User reads Act 5 on agentprivacy.ai
   ‚Üì
2. User forms proverb: "To see without the power to act..."
   ‚Üì
3. User copies memo: ACT:5|To see without the power...
   ‚Üì
4. User sends 0.01 ZEC to zs1...
   ‚Üì
5. Oracle (viewing key) detects transaction
   ‚Üì
6. Oracle fetches canonical proverb from IPFS
   ‚Üì
7. Oracle performs semantic match (score: 0.8234)
   ‚Üì
8. VERIFIED - Oracle signals Signer
   ‚Üì
9. Signer (spending key) executes golden split:
   ‚Ä¢ 0.00618 ZEC ‚Üí t1... (transparent + inscription)
   ‚Ä¢ 0.00382 ZEC ‚Üí zs1... (shielded fee)
   ‚Üì
10. Inscription recorded on-chain: STS|v01|ACT:5|...

======================================
Test Summary
======================================

Passed tests:
  ‚úì Node connection
  ‚úì IPFS spellbook access
  ‚úì Viewing key
  ‚úì Semantic matching
  ‚úì Golden split
  ‚úì Inscription builder

All services running - ready for live testing
```

---

## üöÄ Step 3: Start Services

### 3.1 Using Docker Compose (Recommended)

```bash
# Start all services
docker-compose up -d

# Watch logs
docker-compose logs -f oracle signer
```

### 3.2 Manual Start (Development)

**Terminal 1 - Oracle Service:**
```bash
cd oracle
npm install
npm run dev
```

**Terminal 2 - Signer Service:**
```bash
cd signer
npm install
npm run dev
```

---

## üí∞ Step 4: Send Test Transaction

### 4.1 Prepare Test Donation

**Test Configuration:**
- **Act ID**: 5
- **Test Proverb**: "To see without the power to act is wisdom; to act without seeing is folly."
- **Amount**: 0.01 ZEC (minimum recommended)

### 4.2 Format Memo

The memo format is: `ACT:<act_id>|<proverb>`

Example:
```
ACT:5|To see without the power to act is wisdom; to act without seeing is folly.
```

### 4.3 Send via Zcash Wallet

**Using zecwallet-cli:**
```bash
# Send shielded transaction
zcash-cli z_sendmany "YOUR_SOURCE_ADDRESS" \
  '[{
    "address": "'"$DONATION_Z_ADDRESS"'",
    "amount": 0.01,
    "memo": "ACT:5|To see without the power to act is wisdom; to act without seeing is folly."
  }]'
```

**Using Zashi Wallet (GUI):**
1. Open Zashi wallet
2. Click "Send"
3. Paste donation z-address: `$DONATION_Z_ADDRESS`
4. Enter amount: `0.01`
5. Add memo: `ACT:5|To see without the power to act is wisdom; to act without seeing is folly.`
6. Send transaction

### 4.4 Monitor Transaction

```bash
# Watch Oracle logs
docker-compose logs -f oracle

# Or if running manually
tail -f oracle/logs/oracle.log
```

**Expected Oracle Flow:**
```
[Oracle] New transaction detected: txid=abc123...
[Oracle] Decrypting memo...
[Oracle] Memo parsed: ACT:5|To see without...
[Oracle] Fetching canonical proverb from IPFS...
[Oracle] Canonical proverb: "The swordsman who never strikes guards nothing..."
[Oracle] Running semantic match...
[Oracle] Match score: 0.8234 (threshold: 0.75)
[Oracle] ‚úì VERIFIED - Signaling Signer
[Oracle] POST http://signer:3001/verify
```

---

## ‚öñÔ∏è Step 5: Verify Golden Split

### 5.1 Check Signer Execution

```bash
# Watch Signer logs
docker-compose logs -f signer
```

**Expected Signer Flow:**
```
[Signer] Received verification request: txid=abc123...
[Signer] Calculating golden split for 0.01 ZEC...
[Signer] Split: 0.00618 ZEC ‚Üí t-address, 0.00382 ZEC ‚Üí z-address
[Signer] Building inscription...
[Signer] Inscription: STS|v01|ACT:5|H:a1b2c3d4...|A:61800000|T:1735000000
[Signer] Creating transparent transaction with OP_RETURN...
[Signer] Transaction sent: txid=def456...
[Signer] Creating shielded transaction for fee...
[Signer] Transaction sent: txid=ghi789...
[Signer] ‚úì Golden split executed successfully
```

### 5.2 Verify On-Chain

**Check Transparent Transaction (Sanctuary):**
```bash
# Query transparent address
curl -X POST http://localhost:8232 \
  --user "$ZEBRA_USER:$ZEBRA_PASS" \
  -H "Content-Type: application/json" \
  -d '{
    "jsonrpc": "1.0",
    "id": "test",
    "method": "getreceivedbyaddress",
    "params": ["'$SANCTUARY_T_ADDRESS'", 1]
  }'
```

**Check Inscription:**
```bash
# Get transaction details
curl -X POST http://localhost:8232 \
  --user "$ZEBRA_USER:$ZEBRA_PASS" \
  -H "Content-Type: application/json" \
  -d '{
    "jsonrpc": "1.0",
    "id": "test",
    "method": "gettransaction",
    "params": ["<txid_from_signer_logs>"]
  }'
```

Look for `OP_RETURN` output with inscription data.

**Check Shielded Transaction (Fee):**
```bash
# Using viewing key to check fee address
zcash-cli z_listreceivedbyaddress "$PROTOCOL_FEE_Z_ADDRESS" 1
```

---

## üîç Step 6: Troubleshooting

### Issue: Oracle Not Detecting Transactions

**Check:**
```bash
# Verify viewing key is imported
curl -X POST http://localhost:8232 \
  --user "$ZEBRA_USER:$ZEBRA_PASS" \
  -H "Content-Type: application/json" \
  -d '{
    "jsonrpc": "1.0",
    "id": "test",
    "method": "z_listaddresses"
  }'
```

**Fix:**
```bash
# Re-import viewing key
curl -X POST http://localhost:8232 \
  --user "$ZEBRA_USER:$ZEBRA_PASS" \
  -H "Content-Type: application/json" \
  -d '{
    "jsonrpc": "1.0",
    "id": "test",
    "method": "z_importviewingkey",
    "params": ["'$DONATION_VIEWING_KEY'", "no"]
  }'
```

### Issue: Semantic Match Failing

**Check match threshold:**
```bash
# Lower threshold for testing (in .env)
MATCH_THRESHOLD=0.60  # More lenient
```

**Or test semantic matcher directly:**
```bash
cd oracle
npx ts-node -e "
const { ProverbMatcher } = require('./src/semantic-matcher');
const matcher = new ProverbMatcher();
matcher.compare(
  'Your test proverb',
  'Canonical proverb from spellbook'
).then(score => console.log('Score:', score));
"
```

### Issue: Signer Not Executing Split

**Check:**
- Spending key is correct in `.env`
- Signer service has access to zebrad RPC
- Sufficient balance in donation address
- Network fees are covered

**Verify spending key:**
```bash
# Test spending key import (use testnet!)
# This will show if key is valid
```

### Issue: Inscription Not Appearing

**Check:**
- Transaction confirmed (wait 1-2 minutes)
- OP_RETURN data is correct format
- Transparent address is correct

**Query transaction:**
```bash
# Get transaction details
curl -X POST http://localhost:8232 \
  --user "$ZEBRA_USER:$ZEBRA_PASS" \
  -H "Content-Type: application/json" \
  -d '{
    "jsonrpc": "1.0",
    "id": "test",
    "method": "getrawtransaction",
    "params": ["<txid>", true]
  }' | jq '.result.vout[] | select(.scriptPubKey.type == "nulldata")'
```

---

## üìä Step 7: Production Readiness Checklist

### Infrastructure
- [ ] Zebrad node fully synced
- [ ] RPC authentication configured
- [ ] Firewall rules set (port 8232)
- [ ] Monitoring/logging configured
- [ ] Backup strategy in place

### Keys & Security
- [ ] Viewing key stored securely (Oracle only)
- [ ] Spending key stored securely (Signer only, encrypted)
- [ ] Keys never in same location
- [ ] Key rotation plan documented
- [ ] Access controls configured

### Services
- [ ] Oracle service running in TEE (production)
- [ ] Signer service isolated and secured
- [ ] Health checks configured
- [ ] Auto-restart on failure
- [ ] Rate limiting configured

### Testing
- [ ] Test flow passes all checks
- [ ] Test transaction verified
- [ ] Golden split verified (61.8% / 38.2%)
- [ ] Inscription appears on-chain
- [ ] Semantic matching working
- [ ] Error handling tested

### Documentation
- [ ] Runbook created
- [ ] Incident response plan
- [ ] Key recovery procedure
- [ ] Monitoring dashboards

---

## üéØ Quick Test Commands

```bash
# 1. Test node connection
curl -X POST http://localhost:8232 \
  --user "$ZEBRA_USER:$ZEBRA_PASS" \
  -H "Content-Type: application/json" \
  -d '{"jsonrpc":"1.0","id":"test","method":"getblockcount","params":[]}'

# 2. Test IPFS spellbook
curl -s "https://red-acute-chinchilla-216.mypinata.cloud/ipfs/bafkreiesrv2eolghj6mpbfpqwnff66fl5glevqmps3q6bzlhg5gtyf5jz4" | jq '.version'

# 3. Test Oracle health
curl http://localhost:3000/health

# 4. Test Signer health
curl http://localhost:3001/health

# 5. Run full test flow
./test-flow.sh
```

---

## üìö Next Steps

1. **Read**: `HOW_IT_WORKS.md` - Understand the flow architecture
2. **Review**: `02-ARCHITECTURE.md` - System design details
3. **Deploy**: Follow production deployment guide
4. **Monitor**: Set up Prometheus/Grafana dashboards

---

## üîó Related Documentation

- **[HOW_IT_WORKS.md](./agentprivacy-ai-firstmage/HOW_IT_WORKS.md)** - Technical flow details
- **[02-ARCHITECTURE.md](./02-ARCHITECTURE.md)** - System architecture
- **[ZCASH_README.md](./ZCASH_README.md)** - Zcash integration details
- **[test-flow.sh](./test-flow.sh)** - Automated test script
- **[setup-keys.sh](./setup-keys.sh)** - Key generation script

---

**You're ready for production testing!** üöÄ

Once all tests pass and you've verified the golden split, you can proceed to mainnet deployment.

